name: Build and Release Windows Executable

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.LALC_TOKEN }}
          release-type: simple


  # 构建、打包、上传
  build-and-upload:
    runs-on: windows-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    steps:
      # ---------- 1. 检出 ----------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # ---------- 2. 装工具 ----------
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          cache: true

      - name: Install uv
        run: |
          powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
          echo "$HOME\.cargo\bin" >> $GITHUB_PATH

      # ---------- 3. 后端初始化 ----------
      - name: Backend uv sync
        working-directory: lalc_backend
        run: uv sync

      # ---------- 4. 前端初始化 ----------
      - name: Frontend flutter pub get
        working-directory: lalc_frontend
        run: flutter pub get

      # ---------- 5. 打包 ----------
      - name: Run packup_release.bat
        shell: cmd
        run: packup_release.bat

      # ---------- 6. 读取原 Release Note 并拼接固定前缀 ----------
      - name: Build final release note
        id: final_note
        shell: pwsh
        run: |
          # 固定前缀
          $mirrorChyanLink = "- (推荐，速度快质量好）[已有 Mirror酱 CDK？前往 Mirror酱 高速下载](https://mirrorchyan.com/zh/projects?rid=LALC)"
          $githubLink      = "- (GitHub 有时会限制)[GitHub 最新 Release 下载](https://github.com/HSLix/LixAssistantLimbusCompany/releases/latest) | [Download the latest release from GitHub](https://github.com/HSLix/LixAssistantLimbusCompany/releases/latest)"
          $quarkLink       = "- (不定时更新)重要版本归档：[夸克网盘](https://pan.quark.cn/s/333d6608dddd) | Record Important Version in [KuakeDrive](https://pan.quark.cn/s/333d6608dddd)."
          $discordLink     = "- [加入 Discord 群聊](https://discord.gg/bVzCuBU4bC) | [Join the discord](https://discord.gg/bVzCuBU4bC)"

          $prefix = "$mirrorChyanLink`n$githubLink`n$quarkLink`n$discordLink`n`n"

          # 通过 GitHub CLI 读取
          # 当前 release 的 body（release-please 已生成）
          $tag   = "${{ needs.release-please.outputs.tag_name }}"
          $bodyLines = gh release view $tag --json body --jq .body
          $body = $bodyLines -join "`n"

          # 合并：前缀 + 换行 + 原正文
          $final = "$prefix`n$body"

          # 写到文件（避免 bash 转义问题）
          $final | Out-File -FilePath final_release_note.md -Encoding utf8

          # 输出文件路径
          echo "note_file=final_release_note.md" >> $env:GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.LALC_TOKEN }}

      # ---------- 7. 上传资产 + 更新正文 ----------
      - name: Upload asset & update release note
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.LALC_TOKEN }}
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          body_path: ${{ steps.final_note.outputs.note_file }}
          files: lalc.zip          # 确认根目录存在
          prerelease: ${{ contains(needs.release-please.outputs.tag_name, 'alpha') ||
                          contains(needs.release-please.outputs.tag_name, 'beta') }}
                          
      # ---------- 8. 启动 MirrorChyan ----------
      - name: Trigger MirrorChyanUploading
        shell: bash
        run: |
          gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan-uploading
          gh workflow run --repo $GITHUB_REPOSITORY mirrorchyan-release-note
        env:
          GH_TOKEN: ${{ secrets.LALC_TOKEN }}